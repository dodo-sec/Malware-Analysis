# A FormBook Matryoshka

To those unfamiliar, a matryoshka is a set of Russian dolls of reducing size, where one fits inside the other. These things:

![Picture of Matryoshka](https://github.com/dodo-sec/Malware-Analysis/blob/main/Formbook/Russian-Matryoshka-Doll-Transparent.png)

A "malware matryoshka" refers to a sample that has many stages taking place before the final payload is triggered. 
This analysis will tackle a malicious RTF document that spreads the FormBook infostealer and fits this description quite well

## RTF Maldoc

The first stage is a maldoc. For those that wish to follow along, the file is available on Malware Bazaar ([f443d54ed21c034b61c6e71a4f4705f33684d36b5784aa997461a88e99dc5202](https://bazaar.abuse.ch/sample/f443d54ed21c034b61c6e71a4f4705f33684d36b5784aa997461a88e99dc5202/)).
We have two main options when tackling RTF files: either go with Didier Stevens' rtfdump.py or with rtfobj.py from oletools. The second tool provides a more user friendly output and is used with the syntax `rtfobj [FILE]`:

![rtfobj output](https://github.com/dodo-sec/Malware-Analysis/blob/main/Formbook/rtfobj.png)

There are two embedded objects, the first of which is a vbs script. RTF files do not support VBA macros, so embedding the script is a common alternative employed by attackers. The command to save the object to disk is `rtfobj -s 0 f443d54ed21c034b61c6e71a4f4705f33684d36b5784aa997461a88e99dc5202`. 

## Client.vbs

Let's inspect the contents of the embedded vbs file through Notepad++:

![Beginning of Client.vbs](https://github.com/dodo-sec/Malware-Analysis/blob/main/Formbook/malvbs0.png)

Slmgr.vbs is an official Microsoft script for Volume Activation ([available here](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn502540(v=ws.11))) and it's **long**. Client.vbs is 2063 lines long, only around 300 of which are malicious. 

At line 1779 we find the first hint of something suspicious. Variables and function names starting at this line are long and nonsensical; there are also reversed strings all around.

![line 1779](https://github.com/dodo-sec/Malware-Analysis/blob/main/Formbook/malvbs1.png)

Since string reversing is incredibly common in maldocs, the presence of the **StrReverse** method in code is sure to raise suspicion. To avoid this, many authors create their own implementations of a string reversing function. In this particular case, it's `E0x8C0x9A0x1A0xDE0xB90x3F0x34()`. 
